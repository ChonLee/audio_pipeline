<!DOCTYPE html>
<html>
<head>
  <title>Audio Encoder</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body>
<div class="container mt-5">
  <h1>Upload WAV file for processing.</h1>

  <form id="uploadForm" enctype="multipart/form-data">
    <label>Select Monday</label>
    <input type="date" name="date_str" id="monday-date" class="form-control mb-3" required>

    <label>Show Title</label>
    <input type="text" name="show_title" class="form-control mb-3" placeholder="Title of the show" required>

    <label>Guest</label>
    <input type="text" name="guest" class="form-control mb-3" placeholder="Guest name" required>

    <label>WAV File</label>
    <input type="file" name="wav_file" class="form-control mb-3" required>

    <button type="submit" class="btn btn-primary">Process & Upload</button>
  </form>

  <div class="mt-4">
    <h4>Logs:</h4>
    <pre id="logOutput" style="height:300px; overflow-y:auto; background:#f8f9fa; padding:10px;"></pre>
  </div>
</div>

<script>
const logOutput = document.getElementById('logOutput');

function logMessage(msg) {
    logOutput.textContent += msg + "\n";
    logOutput.scrollTop = logOutput.scrollHeight;
}

const form = document.getElementById("uploadForm");
form.addEventListener("submit", async (e) => {
    e.preventDefault();
    logOutput.textContent = "";
    logMessage("üì§ Uploading file... please wait...");

    const formData = new FormData(form);

    // Convert date from YYYY-MM-DD to MM-DD-YY
    const rawDate = formData.get("date_str");
    if (rawDate) {
        const parts = rawDate.split("-");
        const mm = parts[1];
        const dd = parts[2];
        const yy = parts[0].slice(-2);
        formData.set("date_str", `${mm}-${dd}-${yy}`);
    }

    try {
        const res = await fetch("/upload-audio", { method: 'POST', body: formData });
        const result = await res.json();
        if (!result.success) {
            logMessage("‚ùå Upload failed: " + result.message);
            return;
        }
        logMessage("‚úÖ Upload successful. Processing started...");

        // Listen to SSE for real-time progress using the job ID
        const evtSource = new EventSource("/process-audio-sse/" + result.job_id);

        evtSource.onmessage = function(e) {
            if (e.data === "[DONE]") {
                evtSource.close();
                logMessage("üéâ All processing complete!");
            } else {
                if (e.data.startsWith("Uploading")) {
                    logMessage("üì§ " + e.data);
                } else if (e.data.includes("complete")) {
                    logMessage("‚úÖ " + e.data);
                } else if (e.data.includes("Error") || e.data.includes("‚ùå")) {
                    logMessage("‚ùå " + e.data);
                } else {
                    logMessage("‚ÑπÔ∏è " + e.data);
                }
            }
        };

        evtSource.onerror = function() {
            logMessage("‚ö†Ô∏è Connection lost. Please refresh the page.");
            evtSource.close();
        };

    } catch (err) {
        logMessage("‚ùå Upload failed: " + err.message);
    }
});

document.addEventListener("DOMContentLoaded", function() {
    const dateInput = document.getElementById("monday-date");

    flatpickr(dateInput, {
        dateFormat: "Y-m-d",
        defaultDate: new Date(),
        disable: [
            function(date) {
                // Disable any day that's NOT Monday (getDay() !== 1)
                return date.getDay() !== 1;
            }
        ],
        onReady: function(selectedDates, dateStr, instance) {
            // Set initial value to next Monday
            const today = new Date();
            const daysUntilMonday = (1 + 7 - today.getDay()) % 7 || 7;
            const nextMonday = new Date(today.getTime() + daysUntilMonday * 24*60*60*1000);
            instance.setDate(nextMonday, true);
        }
    });
}); // <-- CLOSES the DOMContentLoaded function
</script>


</body>
</html>
